BootStrap: localimage
From: jupyter23


%help
	    Run a jupyter notebook Server in a container
	    Usually: http://localhost:8888
	    Anaconda Python 3 and ECMWF eccodes (v2.10, py2/3) + cfgrib (py3)
	    Python 2.7 Ipykernel installed
    	Run RTTOV inside a container
		LIBs -> 
		Zugriff auf RTTOV compiled lib  (rttovwrapper_f2py.so)
		Zugriff auf RTTOV coef files (DEFAULT Directory)
		->	PYTHONPATH
		write a little python package, that makes all these resources available
		
		pyrttov ?

%labels
	    Author: M. Blaschek
	    Version: 0.5

%post    
	    # Install jupyter notebook
	    /opt/conda/bin/pip install cfgrib
	    # Additonal
	    apt-get update
	    apt-get install -y --no-install-recommends git build-essential gfortran cmake autotools-dev autoconf libnetcdf*

	    # Clean
	    apt-get autoremove -y
	    apt-get clean

	    # Add SRVX8 directories
	    mkdir -p /raid8/srvx1
	    mkdir -p /opt/dev
	    # Add ECMWF Software
	    
	    # required for CMAKE
	    export PATH=/opt/conda/bin:$PATH
	    export LD_LIBRARY_PATH=/opt/conda/lib:$LD_LIBRARY_PATH
	    
	    mkdir /opt/build
	    cd /opt/build
	    wget https://confluence.ecmwf.int/download/attachments/45757960/eccodes-2.10.0-Source.tar.gz
	    wget http://download.ecmwf.org/test-data/eccodes/eccodes_test_data.tar.gz
	    tar -xzf eccodes-2.*-Source.tar.gz
	    cd eccodes*/
	    mkdir build ; cd build
	    tar -xzf ../../eccodes_test_data.tar.gz -C .
	    cmake -DCMAKE_INSTALL_PREFIX=/usr/local ..
	    make -j4 && ctest && make install
	    # Clean up build environment
	    cd /opt/build
	    # preserve for uninstall or further changes
	    tar czf eccodes-build.tar.gz eccodes*/
	    rm -rf eccodes*/
	    # Add Eccodes to Python Path
	    echo "/usr/local/lib/python3.7/site-packages" > /opt/conda/lib/python3.7/site-packages/eccodes.pth


%environment
	    # important part otherwise the server will try to access /run/user and fail
	    export JUPYTER_RUNTIME_DIR=$PWD/.runtime
	    # Make sure we use container kernels
	    export JUPYTER_DATA_DIR=$PWD/.kernels
	    # Development
	    export LD_LIBRARY_PATH=/opt/conda/lib:/usr/local/lib:$LD_LIBRARY_PATH


	
